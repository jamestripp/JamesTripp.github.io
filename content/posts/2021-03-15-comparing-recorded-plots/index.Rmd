---
title: Comparing recorded plots
author: James Tripp
date: '2021-03-15'
slug: []
categories:
  - R
tags:
  - grapho
draft: yes
---

I'm working on an R package called [Grapho](https://warwickcim.github.io/grapho/). 
The package is part of a Turing funded project called [Ways](https://www.turing.ac.uk/research/research-projects/ways-what-arent-you-seeing).
The package records user activity in R including the plots users create.

Grapho checks for a new plot each time a command is run. If there is a new plot 
then it is written out in a Grapho archive folder. The problem is that Grapho 
needs to a) keep a running record of the plots one has created and b) find out 
if the user has created a new plot.

It is pretty easy to keep a running record. When the package is loaded we 
create an environment for the package. An environment in R is place where we 
can put functions, variables or other objects which are for our package. 
Creating a new environment when loading a package requires us to insert the 
below into our .zzz.R file (for instance, see [the zzz.R file for Grapho](https://github.com/WarwickCIM/grapho/blob/master/R/zzz.R).

```{r, eval=FALSE}
.onLoad <- function(libname, pkgname) {
  assign("grapho",
         new.env(),
         envir = parent.env(environment()))
}
```

Recording plots is easy. There is a nifty recordPlot function in [grDevices](https://stat.ethz.ch/R-manual/R-devel/library/grDevices/html/recordplot.html). 
We can create a plot and then run recordPlot to grab a representation of the plot.

```{r}
plot(cars, xlab = "Speed (mph)", ylab = "Stopping distance (ft)",
     las = 1)
lines(lowess(cars$speed, cars$dist, f = 2/3, iter = 3), col = "red")
title(main = "cars data")

past_plot <- recordPlot()
```

The recorded plot is a dotted list and is certainly not human readable. Instead, 
we can place it into our environment.

```{r, eval=FALSE}
grapho$past_plot <- past_plot
```

Each time our user enters another command we can compare the current and past 
plot using the [identical](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/identical) function.

```{r}
plot(cars, xlab = "Speed (mph)", ylab = "Stopping distance (ft)",
     las = 1)
lines(lowess(cars$speed, cars$dist, f = 2/3, iter = 3), col = "red")
title(main = "cars data")

current_plot <- recordPlot()

identical(past_plot, current_plot)
```

If the plots are different then identical will be false.

```{r}
plot(cars, xlab = "Speed (mph)", ylab = "Stopping distance (ft)",
    las = 1, xlim = c(0, 25))
d <- seq(0, 25, length.out = 200)
for(degree in 1:4) {
  fm <- lm(dist ~ poly(speed, degree), data = cars)
  assign(paste("cars", degree, sep = "."), fm)
  lines(d, predict(fm, data.frame(speed = d)), col = degree)
}

current_plot <- recordPlot()

identical(past_plot, current_plot)
```

Only writing out new plots speeds up the Grapho package. Past iterations wrote 
out the current plot each time a command was evaluated. If the plot is complex 
then that would take a while each command! Using recordPlot and duplicate 
allows R to write only new plots to disk and making the user experience 
far better.

-James
