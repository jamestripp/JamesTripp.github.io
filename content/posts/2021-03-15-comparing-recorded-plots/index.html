---
title: Comparing recorded plots
author: James Tripp
date: '2021-03-15'
slug: []
categories:
  - R
tags:
  - grapho
draft: yes
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<p>Iâ€™m working on an R package called <a href="https://warwickcim.github.io/grapho/">Grapho</a>.
The package is part of a Turing funded project called <a href="https://www.turing.ac.uk/research/research-projects/ways-what-arent-you-seeing">Ways</a>.
The package records user activity in R including the plots users create.</p>
<p>Grapho checks for a new plot each time a command is run. If there is a new plot
then it is written out in a Grapho archive folder. The problem is that Grapho
needs to a) keep a running record of the plots one has created and b) find out
if the user has created a new plot.</p>
<p>It is pretty easy to keep a running record. When the package is loaded we
create an environment for the package. An environment in R is place where we
can put functions, variables or other objects which are for our package.
Creating a new environment when loading a package requires us to insert the
below into our .zzz.R file (for instance, see <a href="https://github.com/WarwickCIM/grapho/blob/master/R/zzz.R">the zzz.R file for Grapho</a>.</p>
<pre class="r"><code>.onLoad &lt;- function(libname, pkgname) {
  assign(&quot;grapho&quot;,
         new.env(),
         envir = parent.env(environment()))
}</code></pre>
<p>Recording plots is easy. There is a nifty recordPlot function in <a href="https://stat.ethz.ch/R-manual/R-devel/library/grDevices/html/recordplot.html">grDevices</a>.
We can create a plot and then run recordPlot to grab a representation of the plot.</p>
<pre class="r"><code>plot(cars, xlab = &quot;Speed (mph)&quot;, ylab = &quot;Stopping distance (ft)&quot;,
     las = 1)
lines(lowess(cars$speed, cars$dist, f = 2/3, iter = 3), col = &quot;red&quot;)
title(main = &quot;cars data&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<pre class="r"><code>past_plot &lt;- recordPlot()</code></pre>
<p>The recorded plot is a dotted list and is certainly not human readable. Instead,
we can place it into our environment.</p>
<pre class="r"><code>grapho$past_plot &lt;- past_plot</code></pre>
<p>Each time our user enters another command we can compare the current and past
plot using the <a href="https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/identical">identical</a> function.</p>
<pre class="r"><code>plot(cars, xlab = &quot;Speed (mph)&quot;, ylab = &quot;Stopping distance (ft)&quot;,
     las = 1)
lines(lowess(cars$speed, cars$dist, f = 2/3, iter = 3), col = &quot;red&quot;)
title(main = &quot;cars data&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<pre class="r"><code>current_plot &lt;- recordPlot()

identical(past_plot, current_plot)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>If the plots are different then identical will be false.</p>
<pre class="r"><code>plot(cars, xlab = &quot;Speed (mph)&quot;, ylab = &quot;Stopping distance (ft)&quot;,
    las = 1, xlim = c(0, 25))
d &lt;- seq(0, 25, length.out = 200)
for(degree in 1:4) {
  fm &lt;- lm(dist ~ poly(speed, degree), data = cars)
  assign(paste(&quot;cars&quot;, degree, sep = &quot;.&quot;), fm)
  lines(d, predict(fm, data.frame(speed = d)), col = degree)
}</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<pre class="r"><code>current_plot &lt;- recordPlot()

identical(past_plot, current_plot)</code></pre>
<pre><code>## [1] FALSE</code></pre>
<p>Only writing out new plots speeds up the Grapho package. Past iterations wrote
out the current plot each time a command was evaluated. If the plot is complex
then that would take a while each command! Using recordPlot and duplicate
allows R to write only new plots to disk and making the user experience
far better.</p>
<p>-James</p>
